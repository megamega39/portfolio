# マグロマップ

## 1. プロジェクト概要

マグロマップは、フードデリバリー配達員向けの高単価案件共有Webアプリケーションです。配達員が受けたオファーの単価と位置情報を地図上で共有し、高単価案件の発生エリアを可視化できます。

- **価格表示**: 6000円以上の案件はクジラ🐋、3000〜5999円の案件はマグロ🐟のアイコンで表示
- **リアルタイム共有**: 投稿されたピンは他のユーザーにも即座に反映
- **プライバシー対応**: 公開・非公開の設定が可能

## 2. 主な機能一覧

### ピンの作成 / 閲覧 / 編集 / 削除

- **作成**: 地図上でクリックした位置にピンを登録。価格、配達距離、時間帯、天候を入力
- **閲覧**: 地図上に表示されたピンをクリックすると詳細情報を表示。ズームレベルに応じて表示制御
- **編集**: ログイン済みユーザーは自分のピンの価格・距離・時間帯・天候を編集可能（位置情報は編集不可）
- **削除**: ログイン済みユーザーは自分のピンを削除可能。未ログインで作成したピンは削除トークンで削除

### 公開・非公開ピン

- **公開ピン**: すべてのユーザーに表示されるピン（デフォルト）
- **非公開ピン**: ログイン済みユーザーのみが作成可能。自分のピンのみ表示される

### マイエリア保存

- ユーザーごとに地図の表示位置（緯度・経度）とズームレベルを保存
- 次回ログイン時に前回の表示位置を自動復元

### 地図共有URL

- ログイン済みユーザーは自分のピン一覧を共有するためのURLを生成可能
- トークンベースの認証により、URLを知っている人のみが閲覧可能

### 認証・パスワード再設定

- **ユーザー登録**: メールアドレスとパスワードで登録。Googleアカウントでの登録も可能
- **ログイン**: メールアドレスとパスワード、またはGoogleアカウントでログイン
- **パスワード再設定**: メールアドレスを入力すると、パスワードリセット用のメールを送信

### レート制限

- ピン作成API（POST /api/pins）に対して、1時間あたり10回のリクエスト制限を適用
- 制限超過時は429エラーを返し、リトライ可能時間を通知

## 3. 技術構成・アーキテクチャ概要

### バックエンド

- **Ruby on Rails 7.2.1**: Webアプリケーションフレームワーク
- **PostgreSQL 15**: リレーショナルデータベース。位置情報（緯度・経度）をdecimal型で保存
- **Puma**: Webサーバー
- **Redis**: レート制限のストレージ（本番環境）

### フロントエンド

- **MapLibre GL JS 3.6.2**: 地図表示ライブラリ。OpenStreetMapの地図データを使用
- **Stimulus**: JavaScriptフレームワーク
- **Tailwind CSS 3.4.1**: CSSフレームワーク
- **esbuild**: JavaScriptバンドラー

### 認証・セキュリティ

- **Devise**: ユーザー認証・セッション管理
- **OmniAuth Google OAuth2**: Googleアカウントでのログイン
- **Rack::Attack**: レート制限ミドルウェア
- **BCrypt**: パスワードハッシュ化、トークン認証

### デプロイ

- **Fly.io**: アプリケーションとPostgreSQLのホスティング。東京リージョン（nrt）で運用

### アーキテクチャ

- **MVCアーキテクチャ**: Railsの標準的な構成
- **APIエンドポイント**: `/api/*` パスでJSON形式のAPIを提供
- **CORS対応**: APIエンドポイントに対してCORSを許可（本番環境では特定ドメインに制限推奨）

## 4. セキュリティ・制限事項

### セキュリティ対策

- **CSRF保護**: Rails標準のCSRFトークン検証（APIエンドポイントは除外）
- **パスワードハッシュ化**: BCryptによるパスワードの安全な保存
- **トークン認証**: ピン削除用トークン、共有マップトークンはBCryptでハッシュ化して保存
- **レート制限**: Rack::AttackによるAPI呼び出し制限
- **入力バリデーション**: モデルレベルでの厳格なバリデーション

### 制限事項

- **ピン作成レート制限**: 1時間あたり10回まで（IPアドレスベース）
- **ピン取得制限**: 1リクエストあたり最大1000件まで
- **価格範囲**: 3000円〜9999円まで
- **配達距離範囲**: 0.1km〜99.9kmまで
- **位置情報範囲**: 緯度-90〜90度、経度-180〜180度
- **非公開ピン**: ログイン済みユーザーのみ作成可能
- **編集・削除権限**: 自分のピンのみ編集・削除可能（管理者は全ピン操作可能）

## 5. 画面・利用イメージ

### トップページ

アプリを開くと、地図上に他のユーザーが登録したピンが表示されます。6000円以上の案件はクジラアイコン、3000〜5999円の案件はマグロアイコンで表示されます。

### ピン作成

地図上をクリックすると、その位置にピンを登録するフォームが表示されます。価格、配達距離、時間帯、天候を入力して投稿します。ログイン済みユーザーは公開・非公開を選択できます。

### ピン詳細表示

地図上のピンをクリックすると、そのピンの詳細情報（価格、配達距離、時間帯、天候、投稿日時）がポップアップで表示されます。

### マイエリア機能

ログイン済みユーザーは、現在表示している地図の位置とズームレベルを保存できます。次回ログイン時に、保存した位置から地図が表示されます。

### 共有マップ機能

ログイン済みユーザーは、自分のピン一覧を共有するためのURLを生成できます。生成されたURLを共有すると、そのURLを知っている人が自分のピン一覧を閲覧できます。

## 6. 使用上の注意・制約

### データ制約

- **価格**: 3000円未満または10000円以上の価格は登録できません
- **配達距離**: 0.1km未満または100km以上の距離は登録できません
- **位置情報**: 緯度・経度は有効な範囲内である必要があります

### 機能制約

- **未ログイン時の制限**: 
  - 非公開ピンは作成できません
  - マイエリア保存機能は使用できません
  - 地図共有URLの生成はできません
  - 自分のピンの編集・削除は削除トークンが必要です

- **共有マップモード時の制限**:
  - 共有マップ閲覧中はピンの編集・削除はできません（管理者も含む）

- **ピン編集の制約**:
  - 位置情報（緯度・経度）は編集できません
  - 未ログイン時に作成したピンは、ログイン後でも可視性（公開/非公開）を変更できません

### レート制限

- ピン作成APIは1時間あたり10回まで。制限超過時は429エラーが返され、一定時間待機が必要です

## 参考リンク

- **Figmaデザイン**: https://www.figma.com/design/mHTKGYHX9PLVKBJAesF5LU/%E3%83%9E%E3%82%B0%E3%83%AD%E3%83%9E%E3%83%83%E3%83%97?node-id=0-1&t=GNRBKevq2nyDFXqh-1
- **ER図**: https://gyazo.com/cda2e80df10966bd20f5367f50a63fcb
